<!DOCTYPE html>
<html>
  <meta charset="utf-8">

  <head>
    <title>Geospatial and Temporal Visualization</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/base/jquery-ui.css" type="text/css" media="all" />
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css"/>
<!--
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.1/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.1/MarkerCluster.Default.css"/>
-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.css" type="text/css">

    <link rel="stylesheet" href="/assets/leaflet-sidebar-v2/leaflet-sidebar.css"/>
    <link rel="stylesheet" href="/assets/leaflet_vector_markers/leaflet-vector-markers.css">

    <link rel="stylesheet" href="/css/map.css">

    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js" type="text/javascript"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.12.2/d3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>

    <script src="js/script.js"></script>
  </head>

  <body class='index-page'>
			<nav class='navbar navbar-default navbar-fixed-top'>
				<div class="container-fluid">
          <div class="row">
            <div class="col-md-8">
              <h2>West Nile Virus across California counties</h2>
            </div>
            <div class="col-md-4 header">
              <p class='extra-space' >Group 
              <a class='extra-space' href="mailto:s9ahmad@eng.ucsd.edu">Salah Ahmad</a>
              <a class='extra-space'  href="mailto:w9yan@eng.ucsd.edu">Wen Yan</a>
              <a class='extra-space'  href="mailto:m3wang@eng.ucsd.edu">Mengting Wang</a>
              </p>
            </div>
          </div><!-- /.row -->
        </div><!-- /.container-fluid -->
			</nav>

		<div id='main-container' class="container-fluid">
			<div class='row'>
				<div class='col-sm-6 col-md-8'>
					<div class='left-container'>
						<div id="map" class="sidebar-map"> </div>
					</div>
				</div>

				<div class='col-sm-6 col-md-4'>
					<div>
						<h2>Control</h2>
						<div class="form-group">
							<label>speed: <strong id='speed'>1</strong>x</label>
							<div id="slider-speed"></div><br>
							<label>time range: <strong id='time-begin'>2006</strong> ~ <strong id='time-end'>2014</strong>  current time:<strong id='time-at'>2006</strong></label>
							<div id="slider-time"></div><br>
							<input id='time-play' class="btn btn-primary" type="button" value="play">
							<input id='time-pause' class="btn btn-primary" type="button" value="pause">
						</div>
					</div>
					<div>
						<h2>statitics</h2>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"></script>
<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.1/leaflet.markercluster-src.js"></script>
-->
<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<script src="/assets/leaflet-sidebar-v2/leaflet-sidebar.min.js"></script>
<script src="/assets/leaflet_vector_markers/leaflet-vector-markers.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script>

//define a boundary box around CA to limit the map to
//let bounds = new L.LatLngBounds(new L.LatLng(33.627056, -117.943720), new L.LatLng(32.226014, -116.5608));
let bounds = new L.LatLngBounds(new L.LatLng(42.245210, -127.278267), new L.LatLng(32.342943, -110.486167));

//create layers
let mbAttr = 'Map data &copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
						 '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
						 'Imagery Â© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> ' +
						 '<a href="https://www.mapbox.com/map-feedback/">Improve map</a>';

mapboxAccessToken = 'pk.eyJ1IjoiYzZzYW5kZXIiLCJhIjoiY2l6ZWpmaHl3MXYwYTJ3cXBlaXBqeXJwcyJ9.QbYtu1dpRdbLFxfhOkqMmA';
let mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + mapboxAccessToken;

let grayscale = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
    streets   = L.tileLayer(mbUrl, {id: 'mapbox.streets', attribution: mbAttr}),
    openstreetmap = L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");

let map = new L.Map("map", {
			center: bounds.getCenter(), maxBounds: bounds,
      maxBoundsViscosity: 1.0, zoom: 7, minZoom: 6, maxZoom: 10,
			layers: [grayscale]}
);

let baseLayers = {
  "Streets": streets,
  "Grayscale": grayscale,
  "Openstreetmap": openstreetmap,
};

var controlLayers = L.control.layers(baseLayers).addTo(map);

function style(feature) {
    return {
        //fillColor: getColor(feature.properties.density),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
    };
}

function onEachFeature(feature, layer) {
		layer._leaflet_id = feature.id; 
    layer.on({
        mouseover: highlightFeature,
        //mouseout: resetHighlight,
    });
}

var county_boundary = new L.geoJson(null, {
                            onEachFeature: onEachFeature
														});
county_boundary.addTo(map);
controlLayers.addOverlay(county_boundary, 'county boundary');

// load virus status data
var virus_data, timeslices, colormap;
function get_data_at_time(data, year_week) {
  return data.filter(function(r) {return (r.Year==year_week[0] && r.Week_Reported == year_week[1]); });
}

var time_begin, time_end;
d3.json("data/West_Nile_Virus_by_County.json", function(error, data) {
  virus_data = data;
  timeslices = d3.map(virus_data, function(r) {return [r.Year, r.Week_Reported];}).keys().sort();
  positive_cases = virus_data.map(function(r) { return r.Positive_Cases; } );
  time_begin = d3.min(positive_cases); 
  time_end = d3.max(positive_cases);
  colormap = d3.scale.linear().domain([time_begin, time_end]).range(["yellow", "red"]);

  
  instance_timeslider();
});

// loading california county geo boundary
var all_counties;
var county_ids = {};
$.ajax({
	dataType: "json",
	url: "data/jsoncounties-CA.min.geojson",
	success: function(data) {
      all = data['features']['counties'];
			all_counties = all;
      for(var i in all) {
        var county = all[i];
        //HACK: fix the format issue in data
        county['id'] = 9000 + i;
				county_ids[county['name']] = county['id'];
        county['type'] = 'Feature';
        county['properties'] = {'name': county['name']};
        if(!('geometry' in county) || !('type' in county['geometry'])) {
					continue;
				}
        if(county['geometry']['type'] == 'MultiPolygon') {
					county['geometry']['coordinates'] = [county['geometry']['coordinates']];
				}
				county_boundary.addData(county);
			}
	}
}).error(function() {});

function set_county_color(county, color) {
  var id = county_ids[county];
  county_boundary.getLayer(id).setStyle({
				fillColor: color,
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
	});
}

function fill_color_at_time(str_year_week) {
  year_week = str_year_week.split(',');
  county_virus = get_data_at_time(virus_data, year_week);
  console.log(virus_data, county_virus);
  county_virus.map(function(r) {
    set_county_color(r.County, colormap(r.Positive_Cases));
	});
}

let sidebar = L.control.sidebar('sidebar').addTo(map);

function play(ti) {
	console.log('playing at time: ' + timeslices[ti]);
  slider_time.slider("value", ti);
	$('#time-at').text(timeslices[ti]);
  //update color
  fill_color_at_time(timeslices[ti]);
}


// events
var slider_speed = $("#slider-speed").slider({
	value: 3,
	min: 1,
	max: 10,
	slide: function( event, ui ) {
		idx = ui.value;
		$('#speed').text(idx);
		//update_charts();
	},
});


function instance_timeslider() {
	$('#time-begin').text(timeslices[0]);
	$('#time-at').text(timeslices[0]);
	$('#time-end').text(timeslices[timeslices.length-1]);
  slider_time = $("#slider-time").slider({
    range: 'min',
		value:0,
		min: 0,
		max: timeslices.length-1,
		slide: function( event, ui ) {
			idx = ui.value;
			$('#time-at').text(timeslices[idx]);
			//update_charts();
		},
		change: function( event, ui ) {
			idx = ui.value;
			$('#time-at').text(timeslices[idx]);
			//update_charts();
		}


	});
}

var play_obj;
$("#time-play" ).click(function() {
  var index = $("#slider-time").slider('value');
  var speed = $("#slider-speed").slider('value');
  play_obj = setInterval(function(){ 
    if(index == timeslices.length-1) {
			clearInterval(play_obj);
		} else {
      play(index);
			index += 1; 
		}
  }, 1000/speed);
});

$("#time-pause" ).click(function() {
	clearInterval(play_obj);
});

</script>
</html>
